# 数据设计文档

## 文档信息

| 项目 | 内容 |
|-----|------|
| 文档名称 | OpenRecommend 数据设计文档 |
| 版本 | 1.0.0 |
| 编写日期 | 2026-02-15 |
| 项目名称 | 多内容类型智能推荐系统 |

---

## 一、数据库设计

### 1.1 数据库概述

**数据库类型**: MySQL 8.0+
**字符集**: utf8mb4
**排序规则**: utf8mb4_unicode_ci
**存储引擎**: InnoDB

### 1.2 数据库表清单

| 序号 | 表名 | 说明 |
|-----|------|------|
| 1 | user | 用户表 |
| 2 | user_profile | 用户画像表 |
| 3 | user_behavior | 用户行为表 |
| 4 | article | 文章表 |
| 5 | article_category | 文章分类表 |
| 6 | image | 图片表 |
| 7 | image_category | 图片分类表 |
| 8 | video | 视频表 |
| 9 | video_category | 视频分类表 |
| 10 | recommend_cache | 推荐结果缓存表 |
| 11 | item_similarity | 物品相似度表 |

---

## 二、表结构设计

### 2.1 用户相关表

#### 2.1.1 用户表 (user)

**表说明**: 存储用户基本信息

```sql
CREATE TABLE `user` (
    `id` BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '用户ID',
    `username` VARCHAR(50) NOT NULL COMMENT '用户名',
    `nickname` VARCHAR(100) COMMENT '昵称',
    `avatar` VARCHAR(500) COMMENT '头像URL',
    `email` VARCHAR(100) UNIQUE COMMENT '邮箱',
    `phone` VARCHAR(20) UNIQUE COMMENT '手机号',
    `password` VARCHAR(200) COMMENT '加密后的密码',
    `salt` VARCHAR(50) COMMENT '密码盐值',
    `status` TINYINT DEFAULT 1 COMMENT '状态：0-禁用，1-正常，2-锁定',
    `register_source` VARCHAR(20) COMMENT '注册来源：web,app,mini',
    `register_ip` VARCHAR(50) COMMENT '注册IP',
    `register_time` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '注册时间',
    `last_login_time` DATETIME COMMENT '最后登录时间',
    `last_login_ip` VARCHAR(50) COMMENT '最后登录IP',
    `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    `update_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    `is_deleted` TINYINT DEFAULT 0 COMMENT '是否删除：0-否，1-是',
    INDEX `idx_username` (`username`),
    INDEX `idx_email` (`email`),
    INDEX `idx_phone` (`phone`),
    INDEX `idx_status` (`status`),
    INDEX `idx_register_time` (`register_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户表';
```

**字段说明**:

| 字段名 | 类型 | 必填 | 默认值 | 说明 |
|-------|------|------|-------|------|
| id | BIGINT | 是 | AUTO_INCREMENT | 主键 |
| username | VARCHAR(50) | 是 | - | 用户名，唯一 |
| nickname | VARCHAR(100) | 否 | NULL | 昵称 |
| avatar | VARCHAR(500) | 否 | NULL | 头像URL |
| email | VARCHAR(100) | 否 | NULL | 邮箱，唯一 |
| phone | VARCHAR(20) | 否 | NULL | 手机号，唯一 |
| password | VARCHAR(200) | 否 | NULL | 加密后的密码 |
| salt | VARCHAR(50) | 否 | NULL | 密码盐值 |
| status | TINYINT | 否 | 1 | 状态：0-禁用，1-正常，2-锁定 |
| register_source | VARCHAR(20) | 否 | NULL | 注册来源 |
| register_ip | VARCHAR(50) | 否 | NULL | 注册IP |
| register_time | DATETIME | 否 | CURRENT_TIMESTAMP | 注册时间 |
| last_login_time | DATETIME | 否 | NULL | 最后登录时间 |
| last_login_ip | VARCHAR(50) | 否 | NULL | 最后登录IP |

---

#### 2.1.2 用户画像表 (user_profile)

**表说明**: 存储用户画像信息，用于推荐算法

```sql
CREATE TABLE `user_profile` (
    `id` BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '画像ID',
    `user_id` BIGINT NOT NULL COMMENT '用户ID',
    `age_range` VARCHAR(20) COMMENT '年龄段：18-24,25-34,35-44,45-54,55+',
    `gender` TINYINT COMMENT '性别：0-未知，1-男，2-女',
    `interest_tags` JSON COMMENT '兴趣标签及权重：{"科技":0.8,"娱乐":0.6}',
    `content_preference` JSON COMMENT '内容类型偏好：{"article":0.5,"image":0.3,"video":0.2}',
    `category_preference` JSON COMMENT '分类偏好：{"科技":0.7,"娱乐":0.3}',
    `active_periods` JSON COMMENT '活跃时段：[8,12,18,22]',
    `device_preference` VARCHAR(20) COMMENT '设备偏好：mobile,pc,tablet',
    `read_preference` JSON COMMENT '阅读偏好：{"short":0.6,"medium":0.3,"long":0.1}',
    `total_read_time` INT DEFAULT 0 COMMENT '总阅读时长（分钟）',
    `total_view_count` INT DEFAULT 0 COMMENT '总浏览量',
    `total_like_count` INT DEFAULT 0 COMMENT '总点赞数',
    `total_collect_count` INT DEFAULT 0 COMMENT '总收藏数',
    `last_update_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '最后更新时间',
    `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    `update_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    UNIQUE KEY `uk_user_id` (`user_id`),
    INDEX `idx_last_update_time` (`last_update_time`),
    INDEX `idx_interest_tags` ((CAST(interest_tags AS CHAR(255)))),
    CONSTRAINT `fk_profile_user` FOREIGN KEY (`user_id`) REFERENCES `user` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户画像表';
```

**字段说明**:

| 字段名 | 类型 | 必填 | 默认值 | 说明 |
|-------|------|------|-------|------|
| id | BIGINT | 是 | AUTO_INCREMENT | 主键 |
| user_id | BIGINT | 是 | - | 用户ID，外键关联user表 |
| age_range | VARCHAR(20) | 否 | NULL | 年龄段 |
| gender | TINYINT | 否 | NULL | 性别：0-未知，1-男，2-女 |
| interest_tags | JSON | 否 | NULL | 兴趣标签及权重 |
| content_preference | JSON | 否 | NULL | 内容类型偏好 |
| category_preference | JSON | 否 | NULL | 分类偏好 |
| active_periods | JSON | 否 | NULL | 活跃时段 |
| device_preference | VARCHAR(20) | 否 | NULL | 设备偏好 |
| read_preference | JSON | 否 | NULL | 阅读偏好 |
| total_read_time | INT | 否 | 0 | 总阅读时长（分钟） |
| total_view_count | INT | 否 | 0 | 总浏览量 |
| total_like_count | INT | 否 | 0 | 总点赞数 |
| total_collect_count | INT | 否 | 0 | 总收藏数 |

---

#### 2.1.3 用户行为表 (user_behavior)

**表说明**: 记录用户的所有行为数据

```sql
CREATE TABLE `user_behavior` (
    `id` BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '行为ID',
    `user_id` BIGINT NOT NULL COMMENT '用户ID',
    `content_type` VARCHAR(20) NOT NULL COMMENT '内容类型：article,image,video',
    `content_id` BIGINT NOT NULL COMMENT '内容ID',
    `behavior_type` TINYINT NOT NULL COMMENT '行为类型：1-浏览，2-点赞，3-收藏，4-分享，5-评论',
    `duration` INT COMMENT '停留时长（秒），仅浏览行为记录',
    `scroll_depth` DECIMAL(5,2) COMMENT '滚动深度（百分比），0-100',
    `is_finish` TINYINT DEFAULT 0 COMMENT '是否完播/完读：0-否，1-是',
    `device` VARCHAR(20) COMMENT '设备类型：mobile,pc,tablet',
    `os` VARCHAR(20) COMMENT '操作系统：iOS,Android,Windows,Mac,Linux',
    `browser` VARCHAR(50) COMMENT '浏览器',
    `ip` VARCHAR(50) COMMENT 'IP地址',
    `location` VARCHAR(100) COMMENT '地理位置',
    `extra_info` JSON COMMENT '额外信息',
    `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '行为时间',
    INDEX `idx_user_id` (`user_id`),
    INDEX `idx_content` (`content_type`, `content_id`),
    INDEX `idx_behavior_type` (`behavior_type`),
    INDEX `idx_create_time` (`create_time`),
    INDEX `idx_user_content` (`user_id`, `content_type`, `content_id`),
    INDEX `idx_user_time` (`user_id`, `create_time`),
    INDEX `idx_content_time` (`content_type`, `content_id`, `create_time`),
    CONSTRAINT `fk_behavior_user` FOREIGN KEY (`user_id`) REFERENCES `user` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户行为表'
PARTITION BY RANGE (TO_DAYS(create_time)) (
    PARTITION p202601 VALUES LESS THAN (TO_DAYS('2026-02-01')),
    PARTITION p202602 VALUES LESS THAN (TO_DAYS('2026-03-01')),
    PARTITION p202603 VALUES LESS THAN (TO_DAYS('2026-04-01')),
    PARTITION pmax VALUES LESS THAN MAXVALUE
);
```

**字段说明**:

| 字段名 | 类型 | 必填 | 默认值 | 说明 |
|-------|------|------|-------|------|
| id | BIGINT | 是 | AUTO_INCREMENT | 主键 |
| user_id | BIGINT | 是 | - | 用户ID |
| content_type | VARCHAR(20) | 是 | - | 内容类型 |
| content_id | BIGINT | 是 | - | 内容ID |
| behavior_type | TINYINT | 是 | - | 行为类型 |
| duration | INT | 否 | NULL | 停留时长（秒） |
| scroll_depth | DECIMAL(5,2) | 否 | NULL | 滚动深度（百分比） |
| is_finish | TINYINT | 否 | 0 | 是否完播/完读 |
| device | VARCHAR(20) | 否 | NULL | 设备类型 |
| os | VARCHAR(20) | 否 | NULL | 操作系统 |
| browser | VARCHAR(50) | 否 | NULL | 浏览器 |
| ip | VARCHAR(50) | 否 | NULL | IP地址 |
| location | VARCHAR(100) | 否 | NULL | 地理位置 |
| extra_info | JSON | 否 | NULL | 额外信息 |
| create_time | DATETIME | 否 | CURRENT_TIMESTAMP | 行为时间 |

**行为类型枚举**:

| 值 | 类型 | 说明 |
|---|------|------|
| 1 | view | 浏览 |
| 2 | like | 点赞 |
| 3 | collect | 收藏 |
| 4 | share | 分享 |
| 5 | comment | 评论 |

---

### 2.2 文章相关表

#### 2.2.1 文章表 (article)

**表说明**: 存储文章内容信息

```sql
CREATE TABLE `article` (
    `id` BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '文章ID',
    `title` VARCHAR(500) NOT NULL COMMENT '文章标题',
    `summary` VARCHAR(1000) COMMENT '文章摘要',
    `content` LONGTEXT NOT NULL COMMENT '文章内容',
    `cover_image` VARCHAR(500) COMMENT '封面图URL',
    `category_id` BIGINT COMMENT '分类ID',
    `tags` JSON COMMENT '标签：["科技","AI"]',
    `keywords` JSON COMMENT '关键词（TF-IDF提取）及权重：{"人工智能":0.9,"深度学习":0.8}',
    `author_id` BIGINT COMMENT '作者ID',
    `source` VARCHAR(100) COMMENT '来源',
    `source_url` VARCHAR(500) COMMENT '来源URL',
    `is_original` TINYINT DEFAULT 1 COMMENT '是否原创：0-否，1-是',
    `word_count` INT COMMENT '字数',
    `read_duration` INT COMMENT '预估阅读时长（分钟）',
    `status` TINYINT DEFAULT 0 COMMENT '状态：0-草稿，1-待审核，2-已发布，3-下架，4-审核拒绝',
    `reject_reason` VARCHAR(500) COMMENT '审核拒绝原因',
    `publish_time` DATETIME COMMENT '发布时间',
    `view_count` BIGINT DEFAULT 0 COMMENT '浏览量',
    `like_count` INT DEFAULT 0 COMMENT '点赞数',
    `comment_count` INT DEFAULT 0 COMMENT '评论数',
    `collect_count` INT DEFAULT 0 COMMENT '收藏数',
    `share_count` INT DEFAULT 0 COMMENT '分享数',
    `finish_read_count` INT DEFAULT 0 COMMENT '完读数',
    `avg_read_duration` INT COMMENT '平均阅读时长（秒）',
    `quality_score` DECIMAL(5,2) DEFAULT 0.00 COMMENT '质量得分（0-100）',
    `content_vector` JSON COMMENT '内容向量（特征）',
    `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    `update_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    `is_deleted` TINYINT DEFAULT 0 COMMENT '是否删除：0-否，1-是',
    INDEX `idx_category_id` (`category_id`),
    INDEX `idx_author_id` (`author_id`),
    INDEX `idx_status` (`status`),
    INDEX `idx_publish_time` (`publish_time`),
    INDEX `idx_quality_score` (`quality_score`),
    INDEX `idx_view_count` (`view_count`),
    FULLTEXT INDEX `ft_title_content` (`title`, `content`),
    CONSTRAINT `fk_article_category` FOREIGN KEY (`category_id`) REFERENCES `article_category` (`id`) ON DELETE SET NULL,
    CONSTRAINT `fk_article_author` FOREIGN KEY (`author_id`) REFERENCES `user` (`id`) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='文章表';
```

**字段说明**:

| 字段名 | 类型 | 必填 | 默认值 | 说明 |
|-------|------|------|-------|------|
| id | BIGINT | 是 | AUTO_INCREMENT | 主键 |
| title | VARCHAR(500) | 是 | - | 文章标题 |
| summary | VARCHAR(1000) | 否 | NULL | 文章摘要 |
| content | LONGTEXT | 是 | - | 文章内容 |
| cover_image | VARCHAR(500) | 否 | NULL | 封面图URL |
| category_id | BIGINT | 否 | NULL | 分类ID |
| tags | JSON | 否 | NULL | 标签 |
| keywords | JSON | 否 | NULL | 关键词及权重 |
| author_id | BIGINT | 否 | NULL | 作者ID |
| source | VARCHAR(100) | 否 | NULL | 来源 |
| source_url | VARCHAR(500) | 否 | NULL | 来源URL |
| is_original | TINYINT | 否 | 1 | 是否原创 |
| word_count | INT | 否 | NULL | 字数 |
| read_duration | INT | 否 | NULL | 预估阅读时长（分钟） |
| status | TINYINT | 否 | 0 | 状态 |
| reject_reason | VARCHAR(500) | 否 | NULL | 审核拒绝原因 |
| publish_time | DATETIME | 否 | NULL | 发布时间 |
| view_count | BIGINT | 否 | 0 | 浏览量 |
| like_count | INT | 否 | 0 | 点赞数 |
| comment_count | INT | 否 | 0 | 评论数 |
| collect_count | INT | 否 | 0 | 收藏数 |
| share_count | INT | 否 | 0 | 分享数 |
| finish_read_count | INT | 否 | 0 | 完读数 |
| avg_read_duration | INT | 否 | NULL | 平均阅读时长（秒） |
| quality_score | DECIMAL(5,2) | 否 | 0.00 | 质量得分（0-100） |
| content_vector | JSON | 否 | NULL | 内容向量（特征） |

**文章状态枚举**:

| 值 | 状态 | 说明 |
|---|------|------|
| 0 | draft | 草稿 |
| 1 | pending | 待审核 |
| 2 | published | 已发布 |
| 3 | offline | 下架 |
| 4 | rejected | 审核拒绝 |

---

#### 2.2.2 文章分类表 (article_category)

**表说明**: 文章分类信息

```sql
CREATE TABLE `article_category` (
    `id` BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '分类ID',
    `name` VARCHAR(50) NOT NULL COMMENT '分类名称',
    `parent_id` BIGINT DEFAULT 0 COMMENT '父分类ID，0表示顶级分类',
    `sort` INT DEFAULT 0 COMMENT '排序',
    `icon` VARCHAR(100) COMMENT '图标',
    `description` VARCHAR(500) COMMENT '描述',
    `status` TINYINT DEFAULT 1 COMMENT '状态：0-禁用，1-启用',
    `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    `update_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    INDEX `idx_parent_id` (`parent_id`),
    INDEX `idx_sort` (`sort`),
    INDEX `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='文章分类表';
```

**字段说明**:

| 字段名 | 类型 | 必填 | 默认值 | 说明 |
|-------|------|------|-------|------|
| id | BIGINT | 是 | AUTO_INCREMENT | 主键 |
| name | VARCHAR(50) | 是 | - | 分类名称 |
| parent_id | BIGINT | 否 | 0 | 父分类ID，0表示顶级分类 |
| sort | INT | 否 | 0 | 排序 |
| icon | VARCHAR(100) | 否 | NULL | 图标 |
| description | VARCHAR(500) | 否 | NULL | 描述 |
| status | TINYINT | 否 | 1 | 状态：0-禁用，1-启用 |

---

### 2.3 图片相关表

#### 2.3.1 图片表 (image)

**表说明**: 存储图片内容信息

```sql
CREATE TABLE `image` (
    `id` BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '图片ID',
    `title` VARCHAR(200) COMMENT '图片标题',
    `description` VARCHAR(1000) COMMENT '图片描述',
    `url` VARCHAR(500) NOT NULL COMMENT '图片URL',
    `thumbnail_url` VARCHAR(500) COMMENT '缩略图URL',
    `width` INT COMMENT '图片宽度（像素）',
    `height` INT COMMENT '图片高度（像素）',
    `aspect_ratio` DECIMAL(5,3) COMMENT '宽高比',
    `file_size` BIGINT COMMENT '文件大小（字节）',
    `format` VARCHAR(10) COMMENT '图片格式：jpg,png,gif,webp',
    `color_depth` INT COMMENT '颜色深度',
    `category_id` BIGINT COMMENT '分类ID',
    `tags` JSON COMMENT '标签：["风景","日落"]',
    `keywords` JSON COMMENT '关键词及权重',
    `uploader_id` BIGINT COMMENT '上传者ID',
    `source` VARCHAR(100) COMMENT '来源',
    `color_histogram` JSON COMMENT '颜色直方图特征',
    `dominant_colors` JSON COMMENT '主色调：["#FF5733","#C70039"]',
    `visual_features` JSON COMMENT '视觉特征向量',
    `status` TINYINT DEFAULT 1 COMMENT '状态：0-待审核，1-已发布，2-下架，3-审核拒绝',
    `reject_reason` VARCHAR(500) COMMENT '审核拒绝原因',
    `publish_time` DATETIME COMMENT '发布时间',
    `view_count` BIGINT DEFAULT 0 COMMENT '浏览量',
    `like_count` INT DEFAULT 0 COMMENT '点赞数',
    `collect_count` INT DEFAULT 0 COMMENT '收藏数',
    `download_count` INT DEFAULT 0 COMMENT '下载次数',
    `quality_score` DECIMAL(5,2) DEFAULT 0.00 COMMENT '质量得分（0-100）',
    `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    `update_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    `is_deleted` TINYINT DEFAULT 0 COMMENT '是否删除：0-否，1-是',
    INDEX `idx_category_id` (`category_id`),
    INDEX `idx_uploader_id` (`uploader_id`),
    INDEX `idx_status` (`status`),
    INDEX `idx_publish_time` (`publish_time`),
    INDEX `idx_quality_score` (`quality_score`),
    INDEX `idx_view_count` (`view_count`),
    CONSTRAINT `fk_image_category` FOREIGN KEY (`category_id`) REFERENCES `image_category` (`id`) ON DELETE SET NULL,
    CONSTRAINT `fk_image_uploader` FOREIGN KEY (`uploader_id`) REFERENCES `user` (`id`) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='图片表';
```

**字段说明**:

| 字段名 | 类型 | 必填 | 默认值 | 说明 |
|-------|------|------|-------|------|
| id | BIGINT | 是 | AUTO_INCREMENT | 主键 |
| title | VARCHAR(200) | 否 | NULL | 图片标题 |
| description | VARCHAR(1000) | 否 | NULL | 图片描述 |
| url | VARCHAR(500) | 是 | - | 图片URL |
| thumbnail_url | VARCHAR(500) | 否 | NULL | 缩略图URL |
| width | INT | 否 | NULL | 图片宽度（像素） |
| height | INT | 否 | NULL | 图片高度（像素） |
| aspect_ratio | DECIMAL(5,3) | 否 | NULL | 宽高比 |
| file_size | BIGINT | 否 | NULL | 文件大小（字节） |
| format | VARCHAR(10) | 否 | NULL | 图片格式 |
| color_depth | INT | 否 | NULL | 颜色深度 |
| category_id | BIGINT | 否 | NULL | 分类ID |
| tags | JSON | 否 | NULL | 标签 |
| keywords | JSON | 否 | NULL | 关键词及权重 |
| uploader_id | BIGINT | 否 | NULL | 上传者ID |
| source | VARCHAR(100) | 否 | NULL | 来源 |
| color_histogram | JSON | 否 | NULL | 颜色直方图特征 |
| dominant_colors | JSON | 否 | NULL | 主色调 |
| visual_features | JSON | 否 | NULL | 视觉特征向量 |
| status | TINYINT | 否 | 1 | 状态 |
| reject_reason | VARCHAR(500) | 否 | NULL | 审核拒绝原因 |
| publish_time | DATETIME | 否 | NULL | 发布时间 |
| view_count | BIGINT | 否 | 0 | 浏览量 |
| like_count | INT | 否 | 0 | 点赞数 |
| collect_count | INT | 否 | 0 | 收藏数 |
| download_count | INT | 否 | 0 | 下载次数 |
| quality_score | DECIMAL(5,2) | 否 | 0.00 | 质量得分（0-100） |

**图片状态枚举**:

| 值 | 状态 | 说明 |
|---|------|------|
| 0 | pending | 待审核 |
| 1 | published | 已发布 |
| 2 | offline | 下架 |
| 3 | rejected | 审核拒绝 |

---

#### 2.3.2 图片分类表 (image_category)

**表说明**: 图片分类信息

```sql
CREATE TABLE `image_category` (
    `id` BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '分类ID',
    `name` VARCHAR(50) NOT NULL COMMENT '分类名称',
    `parent_id` BIGINT DEFAULT 0 COMMENT '父分类ID，0表示顶级分类',
    `sort` INT DEFAULT 0 COMMENT '排序',
    `icon` VARCHAR(100) COMMENT '图标',
    `description` VARCHAR(500) COMMENT '描述',
    `status` TINYINT DEFAULT 1 COMMENT '状态：0-禁用，1-启用',
    `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    `update_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    INDEX `idx_parent_id` (`parent_id`),
    INDEX `idx_sort` (`sort`),
    INDEX `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='图片分类表';
```

---

### 2.4 视频相关表

#### 2.4.1 视频表 (video)

**表说明**: 存储视频内容信息

```sql
CREATE TABLE `video` (
    `id` BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '视频ID',
    `title` VARCHAR(500) NOT NULL COMMENT '视频标题',
    `description` TEXT COMMENT '视频描述',
    `cover_url` VARCHAR(500) NOT NULL COMMENT '封面图URL',
    `video_url` VARCHAR(500) NOT NULL COMMENT '视频URL',
    `duration` INT NOT NULL COMMENT '视频时长（秒）',
    `width` INT COMMENT '视频宽度（像素）',
    `height` INT COMMENT '视频高度（像素）',
    `resolution` VARCHAR(20) COMMENT '分辨率：720p,1080p,4K',
    `format` VARCHAR(20) COMMENT '视频格式：mp4,avi,mov',
    `file_size` BIGINT COMMENT '文件大小（字节）',
    `bitrate` INT COMMENT '比特率（kbps）',
    `fps` DECIMAL(5,2) COMMENT '帧率',
    `category_id` BIGINT COMMENT '分类ID',
    `tags` JSON COMMENT '标签：["搞笑","生活"]',
    `keywords` JSON COMMENT '关键词及权重',
    `uploader_id` BIGINT COMMENT '上传者ID',
    `source` VARCHAR(100) COMMENT '来源',
    `keyframe_features` JSON COMMENT '关键帧特征',
    `visual_features` JSON COMMENT '视觉特征向量',
    `text_features` JSON COMMENT '文本特征向量',
    `status` TINYINT DEFAULT 1 COMMENT '状态：0-待审核，1-已发布，2-下架，3-审核拒绝',
    `reject_reason` VARCHAR(500) COMMENT '审核拒绝原因',
    `publish_time` DATETIME COMMENT '发布时间',
    `view_count` BIGINT DEFAULT 0 COMMENT '播放量',
    `like_count` INT DEFAULT 0 COMMENT '点赞数',
    `comment_count` INT DEFAULT 0 COMMENT '评论数',
    `collect_count` INT DEFAULT 0 COMMENT '收藏数',
    `share_count` INT DEFAULT 0 COMMENT '分享数',
    `finish_watch_count` INT DEFAULT 0 COMMENT '完播数',
    `avg_watch_duration` INT COMMENT '平均观看时长（秒）',
    `quality_score` DECIMAL(5,2) DEFAULT 0.00 COMMENT '质量得分（0-100）',
    `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    `update_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    `is_deleted` TINYINT DEFAULT 0 COMMENT '是否删除：0-否，1-是',
    INDEX `idx_category_id` (`category_id`),
    INDEX `idx_uploader_id` (`uploader_id`),
    INDEX `idx_status` (`status`),
    INDEX `idx_publish_time` (`publish_time`),
    INDEX `idx_quality_score` (`quality_score`),
    INDEX `idx_view_count` (`view_count`),
    INDEX `idx_duration` (`duration`),
    CONSTRAINT `fk_video_category` FOREIGN KEY (`category_id`) REFERENCES `video_category` (`id`) ON DELETE SET NULL,
    CONSTRAINT `fk_video_uploader` FOREIGN KEY (`uploader_id`) REFERENCES `user` (`id`) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='视频表';
```

**字段说明**:

| 字段名 | 类型 | 必填 | 默认值 | 说明 |
|-------|------|------|-------|------|
| id | BIGINT | 是 | AUTO_INCREMENT | 主键 |
| title | VARCHAR(500) | 是 | - | 视频标题 |
| description | TEXT | 否 | NULL | 视频描述 |
| cover_url | VARCHAR(500) | 是 | - | 封面图URL |
| video_url | VARCHAR(500) | 是 | - | 视频URL |
| duration | INT | 是 | - | 视频时长（秒） |
| width | INT | 否 | NULL | 视频宽度（像素） |
| height | INT | 否 | NULL | 视频高度（像素） |
| resolution | VARCHAR(20) | 否 | NULL | 分辨率 |
| format | VARCHAR(20) | 否 | NULL | 视频格式 |
| file_size | BIGINT | 否 | NULL | 文件大小（字节） |
| bitrate | INT | 否 | NULL | 比特率（kbps） |
| fps | DECIMAL(5,2) | 否 | NULL | 帧率 |
| category_id | BIGINT | 否 | NULL | 分类ID |
| tags | JSON | 否 | NULL | 标签 |
| keywords | JSON | 否 | NULL | 关键词及权重 |
| uploader_id | BIGINT | 否 | NULL | 上传者ID |
| source | VARCHAR(100) | 否 | NULL | 来源 |
| keyframe_features | JSON | 否 | NULL | 关键帧特征 |
| visual_features | JSON | 否 | NULL | 视觉特征向量 |
| text_features | JSON | 否 | NULL | 文本特征向量 |
| status | TINYINT | 否 | 1 | 状态 |
| reject_reason | VARCHAR(500) | 否 | NULL | 审核拒绝原因 |
| publish_time | DATETIME | 否 | NULL | 发布时间 |
| view_count | BIGINT | 否 | 0 | 播放量 |
| like_count | INT | 否 | 0 | 点赞数 |
| comment_count | INT | 否 | 0 | 评论数 |
| collect_count | INT | 否 | 0 | 收藏数 |
| share_count | INT | 否 | 0 | 分享数 |
| finish_watch_count | INT | 否 | 0 | 完播数 |
| avg_watch_duration | INT | 否 | NULL | 平均观看时长（秒） |
| quality_score | DECIMAL(5,2) | 否 | 0.00 | 质量得分（0-100） |

**视频状态枚举**:

| 值 | 状态 | 说明 |
|---|------|------|
| 0 | pending | 待审核 |
| 1 | published | 已发布 |
| 2 | offline | 下架 |
| 3 | rejected | 审核拒绝 |

---

#### 2.4.2 视频分类表 (video_category)

**表说明**: 视频分类信息

```sql
CREATE TABLE `video_category` (
    `id` BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '分类ID',
    `name` VARCHAR(50) NOT NULL COMMENT '分类名称',
    `parent_id` BIGINT DEFAULT 0 COMMENT '父分类ID，0表示顶级分类',
    `sort` INT DEFAULT 0 COMMENT '排序',
    `icon` VARCHAR(100) COMMENT '图标',
    `description` VARCHAR(500) COMMENT '描述',
    `status` TINYINT DEFAULT 1 COMMENT '状态：0-禁用，1-启用',
    `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    `update_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    INDEX `idx_parent_id` (`parent_id`),
    INDEX `idx_sort` (`sort`),
    INDEX `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='视频分类表';
```

---

### 2.5 推荐相关表

#### 2.5.1 推荐结果缓存表 (recommend_cache)

**表说明**: 缓存推荐结果

```sql
CREATE TABLE `recommend_cache` (
    `id` BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '缓存ID',
    `user_id` BIGINT NOT NULL COMMENT '用户ID',
    `content_type` VARCHAR(20) COMMENT '内容类型：all,article,image,video',
    `recommend_type` VARCHAR(50) COMMENT '推荐类型：personal,popular,latest',
    `recommend_result` JSON NOT NULL COMMENT '推荐结果JSON',
    `expire_time` DATETIME NOT NULL COMMENT '过期时间',
    `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    INDEX `idx_user_type` (`user_id`, `content_type`, `recommend_type`),
    INDEX `idx_expire_time` (`expire_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='推荐结果缓存表';
```

**字段说明**:

| 字段名 | 类型 | 必填 | 默认值 | 说明 |
|-------|------|------|-------|------|
| id | BIGINT | 是 | AUTO_INCREMENT | 主键 |
| user_id | BIGINT | 是 | - | 用户ID |
| content_type | VARCHAR(20) | 否 | NULL | 内容类型 |
| recommend_type | VARCHAR(50) | 否 | NULL | 推荐类型 |
| recommend_result | JSON | 是 | - | 推荐结果JSON |
| expire_time | DATETIME | 是 | - | 过期时间 |
| create_time | DATETIME | 否 | CURRENT_TIMESTAMP | 创建时间 |

**推荐类型枚举**:

| 类型 | 说明 |
|-----|------|
| personal | 个性化推荐 |
| hot | 热门推荐 |
| related | 相关推荐 |
| latest | 最新推荐 |

---

#### 2.5.2 物品相似度表 (item_similarity)

**表说明**: 存储物品相似度

```sql
CREATE TABLE `item_similarity` (
    `id` BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT 'ID',
    `content_type` VARCHAR(20) NOT NULL COMMENT '内容类型',
    `item_id_1` BIGINT NOT NULL COMMENT '物品1的ID',
    `item_id_2` BIGINT NOT NULL COMMENT '物品2的ID',
    `similarity` DECIMAL(10,6) NOT NULL COMMENT '相似度',
    `calculate_time` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '计算时间',
    UNIQUE KEY `uk_items` (`content_type`, `item_id_1`, `item_id_2`),
    INDEX `idx_item_1` (`content_type`, `item_id_1`),
    INDEX `idx_similarity` (`similarity`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='物品相似度表';
```

**字段说明**:

| 字段名 | 类型 | 必填 | 默认值 | 说明 |
|-------|------|------|-------|------|
| id | BIGINT | 是 | AUTO_INCREMENT | 主键 |
| content_type | VARCHAR(20) | 是 | - | 内容类型 |
| item_id_1 | BIGINT | 是 | - | 物品1的ID |
| item_id_2 | BIGINT | 是 | - | 物品2的ID |
| similarity | DECIMAL(10,6) | 是 | - | 相似度（0-1） |
| calculate_time | DATETIME | 否 | CURRENT_TIMESTAMP | 计算时间 |

---

## 三、Redis数据设计

### 3.1 缓存Key设计规范

```
格式: {prefix}:{identifier}:{suffix}
示例: user_profile:12345
```

### 3.2 缓存数据结构

#### 3.2.1 用户画像缓存

```
Key: user_profile:{userId}
Type: Hash
TTL: 3600s (1小时)

Fields:
  - interest_tags: JSON字符串
  - content_preference: JSON字符串
  - last_update: 时间戳字符串

示例:
  user_profile:12345 -> {
    "interest_tags": "{\"科技\":0.8,\"娱乐\":0.6}",
    "content_preference": "{\"article\":0.5,\"image\":0.3,\"video\":0.2}",
    "last_update": "1707955200"
  }
```

#### 3.2.2 推荐结果缓存

```
Key: recommend:{userId}:{contentType}:{recommendType}
Type: String (JSON)
TTL: 1800s (30分钟)

示例:
  recommend:12345:article:personal -> "[{\"id\":1,\"score\":0.95},{\"id\":2,\"score\":0.88}]"
```

#### 3.2.3 热门内容缓存

```
Key: hot_content:{contentType}:{period}
Type: Sorted Set
TTL: 3600s (1小时)

示例:
  hot_content:article:hour -> {
    "article_1": 1000,
    "article_2": 800,
    "article_3": 600
  }
```

#### 3.2.4 内容特征缓存

```
Key: content_feature:{contentType}:{contentId}
Type: String (JSON)
TTL: 86400s (24小时)

示例:
  content_feature:article:123 -> "{\"keywords\":{\"AI\":0.9,\"深度学习\":0.8},\"vector\":[0.1,0.2,0.3]}"
```

#### 3.2.5 用户行为队列

```
Key: user_behavior_queue
Type: List
TTL: 持久化

示例:
  user_behavior_queue -> [
    "{\"userId\":123,\"type\":\"view\",\"contentId\":456,\"timestamp\":1707955200}",
    "{\"userId\":123,\"type\":\"like\",\"contentId\":789,\"timestamp\":1707955260}"
  ]
```

#### 3.2.6 分布式锁

```
Key: lock:{userId}:{operation}
Type: String
TTL: 30s

示例:
  lock:123:update_profile -> "1"
```

### 3.3 缓存策略

| 数据类型 | 缓存策略 | 过期时间 | 更新时机 |
|---------|---------|---------|---------|
| 用户画像 | Cache-Aside | 1小时 | 用户行为更新时 |
| 推荐结果 | Write-Through | 10-30分钟 | 每次计算后 |
| 热门内容 | Write-Behind | 1小时 | 定时任务更新 |
| 内容特征 | Cache-Aside | 24小时 | 内容更新时 |
| 相似度矩阵 | Cache-Aside | 7天 | 定时计算 |

---

## 四、数据字典

### 4.1 内容类型枚举

| 值 | 类型 | 说明 |
|---|------|------|
| article | 文章 | 文章类型内容 |
| image | 图片 | 图片类型内容 |
| video | 视频 | 视频类型内容 |
| all | 全部 | 全部内容类型 |

### 4.2 行为类型枚举

| 值 | 类型 | 说明 |
|---|------|------|
| 1 | view | 浏览 |
| 2 | like | 点赞 |
| 3 | collect | 收藏 |
| 4 | share | 分享 |
| 5 | comment | 评论 |

### 4.3 内容状态枚举

| 值 | 状态 | 说明 |
|---|------|------|
| 0 | draft/pending | 草稿/待审核 |
| 1 | published | 已发布 |
| 2 | offline | 下架 |
| 3 | rejected | 审核拒绝 |

### 4.4 推荐类型枚举

| 值 | 类型 | 说明 |
|---|------|------|
| personal | 个性化推荐 | 基于用户画像的推荐 |
| hot | 热门推荐 | 基于热度的推荐 |
| related | 相关推荐 | 基于内容相似度的推荐 |
| latest | 最新推荐 | 基于时间的推荐 |

---

## 五、数据初始化

### 5.1 初始化SQL脚本

```sql
-- 创建数据库
CREATE DATABASE IF NOT EXISTS openrecommend
DEFAULT CHARACTER SET utf8mb4
DEFAULT COLLATE utf8mb4_unicode_ci;

USE openrecommend;

-- 创建表（按顺序执行）
-- 1. 创建分类表
-- 2. 创建用户表
-- 3. 创建内容表
-- 4. 创建其他相关表

-- 插入默认分类数据
INSERT INTO article_category (name, parent_id, sort, status) VALUES
('科技', 0, 1, 1),
('娱乐', 0, 2, 1),
('体育', 0, 3, 1),
('教育', 0, 4, 1);

INSERT INTO image_category (name, parent_id, sort, status) VALUES
('风景', 0, 1, 1),
('人像', 0, 2, 1),
('建筑', 0, 3, 1),
('艺术', 0, 4, 1);

INSERT INTO video_category (name, parent_id, sort, status) VALUES
('搞笑', 0, 1, 1),
('生活', 0, 2, 1),
('教育', 0, 3, 1),
('音乐', 0, 4, 1);
```

---

## 六、数据迁移与备份

### 6.1 备份策略

```bash
# 每日全量备份
mysqldump -u root -p openrecommend > /backup/openrecommend_$(date +%Y%m%d).sql

# 每小时增量备份（binlog）
# 配置MySQL binlog
[mysqld]
log-bin=mysql-bin
binlog-format=ROW
expire_logs_days=7
```

### 6.2 恢复策略

```bash
# 全量恢复
mysql -u root -p openrecommend < /backup/openrecommend_20260215.sql

# 增量恢复
mysqlbinlog mysql-bin.000123 | mysql -u root -p openrecommend
```

---

## 七、附录

### 7.1 ER图

```
┌─────────┐         ┌─────────────────┐
│  user   │◄───────►│ user_profile    │
└─────────┘         └─────────────────┘
    │                      │
    │                      │
    │                      │
    ▼                      ▼
┌─────────────┐    ┌─────────────┐
│ article     │    │ user_       │
│ image       │    │ behavior    │
│ video       │    └─────────────┘
└─────────────┘           │
    │                     │
    ▼                     ▼
┌─────────────┐    ┌─────────────┐
│ *_category  │    │ recommend_  │
└─────────────┘    │ cache       │
                  └─────────────┘
```

### 7.2 索引设计说明

#### 7.2.1 用户行为表索引

```sql
-- 复合索引：查询用户近期行为
INDEX `idx_user_time` (`user_id`, `create_time`)

-- 复合索引：查询内容互动数据
INDEX `idx_content_time` (`content_type`, `content_id`, `create_time`)
```

#### 7.2.2 内容表索引

```sql
-- 复合索引：查询已发布的质量内容
INDEX `idx_status_publish_quality` (`status`, `publish_time`, `quality_score`)
```

### 7.3 数据量预估

| 表名 | 预估数据量 | 存储预估 |
|-----|-----------|---------|
| user | 100万 | 500MB |
| user_profile | 100万 | 2GB |
| user_behavior | 1亿 | 50GB |
| article | 1000万 | 100GB |
| image | 500万 | 30GB |
| video | 100万 | 20GB |
| item_similarity | 5000万 | 200GB |
| 合计 | - | ~400GB |

### 7.4 性能优化建议

1. **分区策略**: user_behavior表按月分区
2. **读写分离**: 主库写，从库读
3. **缓存策略**: 热点数据Redis缓存
4. **索引优化**: 根据查询模式优化索引
5. **归档策略**: 历史数据定期归档

### 7.5 变更记录

| 版本 | 日期 | 变更内容 | 变更人 |
|-----|------|---------|-------|
| 1.0.0 | 2026-02-15 | 初始版本 | - |
